@using System
@inherits Sandbox.UI.Panel
@namespace Monopoly.UI.Screens.GameLoop

@* There are dragons in here *@
@* magical regex to match all parent ids in match group 1: id="(?!.*-disabled)([^"]*)" *@

<root>
<div style="display: flex; flex-direction: row; width: 100%; justify-content: space-evenly">
	<div class="ownership-dot-column">
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="brown1"
			Selected=@TradeFields["brown1"]
			ColorClass="brown"
			Mortgaged=@GetMortagedStatus("brown1")
			Owned=@(Owned["brown1"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="brown2"
			Selected=@TradeFields["brown2"]
			ColorClass="brown"
			Mortgaged=@GetMortagedStatus("brown2")
			Owned=@(Owned["brown2"] == SteamId)>
		</OwnershipDot>
	</div>
	<div class="ownership-dot-column">
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="lightBlue1"
			Selected=@TradeFields["lightBlue1"]
			ColorClass="lightBlue"
			Mortgaged=@GetMortagedStatus("lightBlue1")
			Owned=@(Owned["lightBlue1"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="lightBlue2"
			Selected=@TradeFields["lightBlue2"]
			ColorClass="lightBlue"
			Mortgaged=@GetMortagedStatus("lightBlue2")
			Owned=@(Owned["lightBlue2"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="lightBlue3"
			Selected=@TradeFields["lightBlue3"]
			ColorClass="lightBlue"
			Mortgaged=@GetMortagedStatus("lightBlue3")
			Owned=@(Owned["lightBlue3"] == SteamId)>
		</OwnershipDot>
	</div>
	<div class="ownership-dot-column">
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="pink1"
			Selected=@TradeFields["pink1"]
			ColorClass="pink"
			Mortgaged=@GetMortagedStatus("pink1")
			Owned=@(Owned["pink1"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="pink2"
			Selected=@TradeFields["pink2"]
			ColorClass="pink"
			Mortgaged=@GetMortagedStatus("pink2")
			Owned=@(Owned["pink2"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="pink3"
			Selected=@TradeFields["pink3"]
			ColorClass="pink"
			Mortgaged=@GetMortagedStatus("pink3")
			Owned=@(Owned["pink3"] == SteamId)>
		</OwnershipDot>
	</div>
	<div class="ownership-dot-column">
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="orange1"
			Selected=@TradeFields["orange1"]
			ColorClass="orange"
			Mortgaged=@GetMortagedStatus("orange1")
			Owned=@(Owned["orange1"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="orange2"
			Selected=@TradeFields["orange2"]
			ColorClass="orange"
			Mortgaged=@GetMortagedStatus("orange2")
			Owned=@(Owned["orange2"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="orange3"
			Selected=@TradeFields["orange3"]
			ColorClass="orange"
			Mortgaged=@GetMortagedStatus("orange3")
			Owned=@(Owned["orange3"] == SteamId)>
		</OwnershipDot>
	</div>
	<div class="ownership-dot-column">
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="red1"
			Selected=@TradeFields["red1"]
			ColorClass="red"
			Mortgaged=@GetMortagedStatus("red1")
			Owned=@(Owned["red1"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="red2"
			Selected=@TradeFields["red2"]
			ColorClass="red"
			Mortgaged=@GetMortagedStatus("red2")
			Owned=@(Owned["red2"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="red3"
			Selected=@TradeFields["red3"]
			ColorClass="red"
			Mortgaged=@GetMortagedStatus("red3")
			Owned=@(Owned["red3"] == SteamId)>
		</OwnershipDot>
	</div>
	<div class="ownership-dot-column">
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="yellow1"
			Selected=@TradeFields["yellow1"]
			ColorClass="yellow"
			Mortgaged=@GetMortagedStatus("yellow1")
			Owned=@(Owned["yellow1"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="yellow2"
			Selected=@TradeFields["yellow2"]
			ColorClass="yellow"
			Mortgaged=@GetMortagedStatus("yellow2")
			Owned=@(Owned["yellow2"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="yellow3"
			Selected=@TradeFields["yellow3"]
			ColorClass="yellow"
			Mortgaged=@GetMortagedStatus("yellow3")
			Owned=@(Owned["yellow3"] == SteamId)>
		</OwnershipDot>
	</div>
	<div class="ownership-dot-column">
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="green1"
			Selected=@TradeFields["green1"]
			ColorClass="green"
			Mortgaged=@GetMortagedStatus("green1")
			Owned=@(Owned["green1"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="green2"
			Selected=@TradeFields["green2"]
			ColorClass="green"
			Mortgaged=@GetMortagedStatus("green2")
			Owned=@(Owned["green2"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="green3"
			Selected=@TradeFields["green3"]
			ColorClass="green"
			Mortgaged=@GetMortagedStatus("green3")
			Owned=@(Owned["green3"] == SteamId)>
		</OwnershipDot>
	</div>
	<div class="ownership-dot-column">
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="blue1"
			Selected=@TradeFields["blue1"]
			ColorClass="blue"
			Mortgaged=@GetMortagedStatus("blue1")
			Owned=@(Owned["blue1"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="blue2"
			Selected=@TradeFields["blue2"]
			ColorClass="blue"
			Mortgaged=@GetMortagedStatus("blue2")
			Owned=@(Owned["blue2"] == SteamId)>
		</OwnershipDot>
	</div>
</div>
<div>
	<div style="display: flex; flex-direction: row; justify-content: space-evenly; width: 100%">
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="railroad1"
			Selected=@TradeFields["railroad1"]
			ColorClass="black"
			Mortgaged=@GetMortagedStatus("railroad1")
			Owned=@(Owned["railroad1"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="railroad2"
			Selected=@TradeFields["railroad2"]
			ColorClass="black"
			Mortgaged=@GetMortagedStatus("railroad2")
			Owned=@(Owned["railroad2"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="railroad3"
			Selected=@TradeFields["railroad3"]
			ColorClass="black"
			Mortgaged=@GetMortagedStatus("railroad3")
			Owned=@(Owned["railroad3"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="railroad4"
			Selected=@TradeFields["railroad4"]
			ColorClass="black"
			Mortgaged=@GetMortagedStatus("railroad4")
			Owned=@(Owned["railroad4"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="electricCompany"
			Selected=@TradeFields["electricCompany"]
			ColorClass="gray"
			Mortgaged=@GetMortagedStatus("electricCompany")
			Owned=@(Owned["electricCompany"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="waterCompany"
			Selected=@TradeFields["waterCompany"]
			ColorClass="gray"
			Mortgaged=@GetMortagedStatus("waterCompany")
			Owned=@(Owned["waterCompany"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="chanceJailFree"
			Selected=@TradeFields["chanceJailFree"]
			ColorClass="policeBlue"
			Owned=@(Owned["chanceJailFree"] == SteamId)>
		</OwnershipDot>
		<OwnershipDot
			OnSelect=@OwnershipDotClick
			FieldName="communityJailFree"
			Selected=@TradeFields["communityJailFree"]
			ColorClass="policeBlue"
			Owned=@(Owned["communityJailFree"] == SteamId)>
		</OwnershipDot>
	</div>
</div>
</root>

@code {

	[Property]
	public Player Player { get; set; }

	public ulong SteamId => Player.SteamId;

	[Property]
	public NetDictionary<string, ulong> Owned { get; set; }

	[Property]
	public NetDictionary<string, bool> TradeFields { get; set; }

	private IEnumerable<GameObject> _gameLocations = Game.ActiveScene.Children[0].Children;

	private bool GetMortagedStatus(string propertyName) {
		var currentLocation = _gameLocations.First(o => o.Name == propertyName).Components.Get<GameLocation>();
		return currentLocation.Mortgaged;
	}

	/// <summary>
	///     the hash determines if the system should be rebuilt. If it changes, it will be rebuilt
	/// </summary>
	protected override int BuildHash() {
		return HashCode.Combine(Player.Money);
	}

	private void OwnershipDotClick(string field) {
		ToggleField(field);
	}

	private void ToggleField(string fieldName) {
		if (!fieldName.Contains("JailFree")) {
			var currentLocation = _gameLocations.First(o => o.Name == fieldName).Components.Get<GameLocation>();

			if (Owned[fieldName] == SteamId && currentLocation.Houses == 0) {
				TradeFields[fieldName] = !TradeFields[fieldName];
			}
		}
		else {
			if (Owned[fieldName] == SteamId) {
				TradeFields[fieldName] = !TradeFields[fieldName];
			}
		}
	}

}
